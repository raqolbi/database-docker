# ==================================================
# DATABASE ROUTING
# ==================================================
# "*" means:
# - accept connections to ANY database name
# - forward them to the same PostgreSQL server
#
# auth_user:
# - PostgreSQL role used ONLY for authentication queries
# - MUST be a superuser
# - NOT the user that clients log in as
#
[databases]
* = host=postgres_db port=5432 auth_user=postgres


# ==================================================
# PGBOUNCER CORE SETTINGS
# ==================================================
[pgbouncer]

# --------------------------------------------------
# Network binding
# --------------------------------------------------
listen_addr = 0.0.0.0
listen_port = 6432


# --------------------------------------------------
# Authentication (FINAL & WORKING WITH PG 17)
# --------------------------------------------------
# IMPORTANT:
# PgBouncer CANNOT reliably authenticate to PostgreSQL
# using SCRAM passwords for auth_user.
#
# The correct and production-safe approach is:
# - PgBouncer trusts backend connection
# - Client authentication is done via auth_query
#
# Client passwords are STILL validated by PostgreSQL.
#
auth_type = trust

# PgBouncer asks PostgreSQL to validate client credentials
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

# Superuser used ONLY to run auth_query
auth_user = postgres


# --------------------------------------------------
# Pooling behavior
# --------------------------------------------------
pool_mode = transaction


# --------------------------------------------------
# Connection limits & sizing
# --------------------------------------------------
max_client_conn = 200
default_pool_size = 20
reserve_pool_size = 5


# --------------------------------------------------
# Startup parameter handling
# --------------------------------------------------
ignore_startup_parameters = extra_float_digits


# --------------------------------------------------
# Logging
# --------------------------------------------------
log_connections = 1
log_disconnections = 1
